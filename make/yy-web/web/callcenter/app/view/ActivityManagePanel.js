/*
 * File: app/view/ActivityManagePanel.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CallCenterApp.view.ActivityManagePanel', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.activitymanagepanel',

    requires: [
        'CallCenterApp.view.ActivityManagePanelViewModel',
        'CallCenterApp.view.ActivityManagePanelViewController',
        'Ext.toolbar.Toolbar',
        'Ext.form.field.ComboBox',
        'Ext.button.Button',
        'Ext.grid.Panel',
        'Ext.grid.column.RowNumberer',
        'Ext.grid.column.Date',
        'Ext.grid.column.Action',
        'Ext.grid.View',
        'Ext.grid.plugin.CellEditing'
    ],

    controller: 'activitymanagepanel',
    viewModel: {
        type: 'activitymanagepanel'
    },
    id: 'ActivityManagePanel',
    itemId: 'ActivityManagePanel',
    closable: true,
    title: '活动管理',

    layout: {
        type: 'vbox',
        align: 'stretch'
    },
    dockedItems: [
        {
            xtype: 'toolbar',
            dock: 'top',
            height: 40,
            items: [
                {
                    xtype: 'combobox',
                    itemId: 'systemSelector',
                    fieldLabel: '系统',
                    labelAlign: 'right',
                    labelWidth: 36,
                    editable: false,
                    displayField: 'f_stname',
                    store: 'BusinessSystemManagerStore',
                    valueField: 'f_stid',
                    listeners: {
                        select: 'onSystemSelectorSelect',
                        beforerender: 'onSystemSelectorBeforeRender'
                    }
                },
                {
                    xtype: 'button',
                    itemId: 'addBtn',
                    text: '新增活动',
                    listeners: {
                        click: 'onAddBtnClick'
                    }
                }
            ]
        }
    ],
    items: [
        {
            xtype: 'gridpanel',
            flex: 2,
            height: 142,
            itemId: 'ActivityGridPanel',
            title: '',
            store: 'ActivityStore',
            columns: [
                {
                    xtype: 'rownumberer',
                    width: 50,
                    align: 'center',
                    text: '序号'
                },
                {
                    xtype: 'gridcolumn',
                    frame: true,
                    width: 170,
                    align: 'center',
                    dataIndex: 'title',
                    text: '标题',
                    editor: {
                        xtype: 'textfield',
                        selectOnFocus: true
                    }
                },
                {
                    xtype: 'datecolumn',
                    frame: true,
                    width: 250,
                    enableFocusableContainer: true,
                    align: 'center',
                    dataIndex: 'startdate',
                    text: '开始时间',
                    format: 'Y-m-d H:i:s',
                    editor: {
                        xtype: 'textfield',
                        selectOnFocus: true
                    }
                },
                {
                    xtype: 'datecolumn',
                    frame: true,
                    width: 250,
                    enableFocusableContainer: true,
                    align: 'center',
                    dataIndex: 'enddate',
                    text: '结束时间',
                    format: 'Y-m-d H:i:s',
                    editor: {
                        xtype: 'textfield',
                        selectOnFocus: true
                    }
                },
                {
                    xtype: 'gridcolumn',
                    renderer: function (value, metaData, record, rowIndex, colIndex, store, view) {
                        if (value === 0) {
                            return '限时购';

                        } else if (value === 1) {
                            return '促销车';
                        }
                    },
                    align: 'center',
                    dataIndex: 'type',
                    text: '类型'
                },
                {
                    xtype: 'gridcolumn',
                    frame: true,
                    enableFocusableContainer: true,
                    align: 'center',
                    dataIndex: 'content',
                    text: '内容',
                    editor: {
                        xtype: 'textfield',
                        selectOnFocus: true
                    }
                },
                {
                    xtype: 'actioncolumn',
                    text: '操作',
                    items: [
                        {
                            handler: function (view, rowIndex, colIndex, item, e, record, row) {

                                var acid = record.data.acid;
                                var stid = record.data.stid;
                                var type = record.data.type;
                                var url = Ext.getStore('ConfigStore').getAt(0).get('OrderUrl');

                                var activityCarRequestPanel = new CallCenterApp.view.ActivityCarRequestPanel({
                                    acid: acid,
                                    stid: stid,
                                    type: type
                                });

                                var myForm = new Ext.window.Window({
                                    modal: true,
                                    autoScroll: true,
                                    title: '添加售车信息',
                                    width: 800,
                                    height: 600
                                });

                                myForm.add(activityCarRequestPanel);
                                myForm.show();
                            },
                            altText: '添加售车信息',
                            iconCls: 'Carstart',
                            tooltip: '添加售车信息'
                        },
                        {
                            handler: function (view, rowIndex, colIndex, item, e, record, row) {
                                Ext.MessageBox.confirm('请确认', '您确认保存该条记录吗？', function (btn) {

                                    if (btn === 'no') {
                                        return;
                                    } else if (btn === 'yes') {

                                        var id = record.data.acid;
                                        var title = record.data.title;
                                        var startdate = record.data.startdate.getTime() / 1000;
                                        var enddate = record.data.enddate.getTime() / 1000;
                                        var type = record.data.type;
                                        var stid = record.data.stid;
                                        var content = record.data.content;
                                        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderUrl');

                                        var data = {
                                            acid: id,
                                            title: title,
                                            startdate: startdate,
                                            enddate: enddate,
                                            type: type,
                                            stid: stid,
                                            content: content
                                        };
                                        Ext.Ajax.request({
                                            headers: {'Content-Type': 'application/json'},
                                            url: url + "/biz/app/activities/update.do",
                                            params: JSON.stringify(data),

                                            success: function (response) {
                                                var text = response.responseText;
                                                var result = JSON.parse(text);

                                                if (result === null) {
                                                    Ext.Msg.alert('提示', '保存出错了，结果：' + result);
                                                    return;
                                                } else if (result.succeed) {
                                                    view.store.reload();
                                                    Ext.Msg.alert('提示', '保存成功');
                                                } else {
                                                    Ext.Msg.alert('提示', '保存出错了，错误：' + result.ptError);
                                                    return;
                                                }
                                            },

                                            failure: function () {
                                                Ext.Msg.alert('提示', '保存失败');

                                            },
                                        });

                                    }
                                });
                            },
                            altText: '保存',
                            iconCls: 'Scriptsave',
                            tooltip: '保存'
                        },
                        {
                            handler: function (view, rowIndex, colIndex, item, e, record, row) {
                                Ext.MessageBox.confirm('请确认', '您确认删除该条记录吗？', function (btn) {

                                    if (btn === 'no') {
                                        return;
                                    } else if (btn === 'yes') {

                                        var id = record.data.acid;
                                        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderUrl');

                                        Ext.Ajax.request({
                                            url: url + "/biz/app/activities/delete.do",
                                            params: {
                                                id: id
                                            },

                                            success: function (response) {
                                                var text = response.responseText;
                                                var result = JSON.parse(text);

                                                if (result === null) {
                                                    Ext.Msg.alert('提示', '删除出错了，结果：' + result);
                                                    return;
                                                } else if (result.succeed) {
                                                    view.store.reload();
                                                    Ext.Msg.alert('提示', '删除成功');
                                                } else {
                                                    Ext.Msg.alert('提示', '删除出错了，错误：' + result.ptError);
                                                    return;
                                                }
                                            },

                                            failure: function () {
                                                Ext.Msg.alert('提示', '删除失败');

                                            },
                                        });

                                    }
                                });
                            },
                            altText: '删除',
                            iconCls: 'Bulletcross',
                            tooltip: '删除'
                        }
                    ]
                }
            ],
            listeners: {
                rowclick: 'onActivityGridPanelRowClick'
            },
            plugins: [
                {
                    ptype: 'cellediting'
                }
            ]
        },
        {
            xtype: 'gridpanel',
            flex: 3,
            itemId: 'ActivityCarGridPanel',
            store: 'ActivityCarStore',
            columns: [
                {
                    xtype: 'rownumberer',
                    width: 50,
                    align: 'center',
                    text: '序号'
                },
                {
                    xtype: 'gridcolumn',
                    align: 'center',
                    dataIndex: 'carbrand',
                    text: '品牌'
                },
                {
                    xtype: 'gridcolumn',
                    align: 'center',
                    dataIndex: 'carset',
                    text: '车型'
                },
                {
                    xtype: 'gridcolumn',
                    align: 'center',
                    dataIndex: 'cartype',
                    text: '车款'
                },
                {
                    xtype: 'gridcolumn',
                    align: 'center',
                    dataIndex: 'color',
                    text: '车款颜色'
                },
                {
                    xtype: 'gridcolumn',
                    align: 'center',
                    dataIndex: 'lessprice',
                    text: '优惠/降价'
                },
                {
                    xtype: 'actioncolumn',
                    text: '操作',
                    items: [
                        {
                            handler: function (view, rowIndex, colIndex, item, e, record, row) {
                                Ext.MessageBox.confirm('请确认', '您确认删除该条记录吗？', function (btn) {

                                    if (btn === 'no') {
                                        return;
                                    } else if (btn === 'yes') {

                                        var id = record.data.svid;
                                        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderUrl');

                                        Ext.Ajax.request({
                                            url: url + "/biz/app/salesvehicle/delete.do",
                                            params: {
                                                id: id
                                            },

                                            success: function (response) {
                                                var text = response.responseText;
                                                var result = JSON.parse(text);

                                                if (result === null) {
                                                    Ext.Msg.alert('提示', '删除出错了，结果：' + result);
                                                    return;
                                                } else if (result.succeed) {
                                                    view.store.reload();
                                                    Ext.Msg.alert('提示', '删除成功');
                                                } else {
                                                    Ext.Msg.alert('提示', '删除出错了，错误：' + result.ptError);
                                                    return;
                                                }
                                            },

                                            failure: function () {
                                                Ext.Msg.alert('提示', '删除失败');

                                            },
                                        });

                                    }
                                });
                            },
                            altText: '删除',
                            iconCls: 'Bulletcross',
                            tooltip: '删除'
                        }
                    ]
                }
            ]
        }
    ]

});