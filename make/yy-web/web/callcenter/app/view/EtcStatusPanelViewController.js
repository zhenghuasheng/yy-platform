/*
 * File: app/view/EtcStatusPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CallCenterApp.view.EtcStatusPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.etcstatuspanel',

    onEtcStatusGridpanelCellContextMenu: function (tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        /***列表页面，右键事件****/
        var targetDel = "/action/etc/delete.do";
        var storeId = 'EtcStatusStore';
        var refreshUrl = "/action/etc/list.do?system=ytadmin@7788";
        var rightMenu = new CallCenterApp.view.RightClickMenu({
            record: record,
            targetDel: targetDel,
            storeId: storeId,
            refreshUrl: refreshUrl
        });
        e.preventDefault();
        //定位。显示 右键菜单
        rightMenu.showAt(e.getXY());
    },

    onEtcStatusGridPanelRowClick: function (tableview, record, tr, rowIndex, e, eOpts) {
        var record = record.data;
        EtcStatusPropertyGrid = Ext.getCmp('EtcStatusPropertyGrid');

        var s = record.f_source;
        var sourceName = (record.f_sourcename === undefined) ? '' : record.f_sourcename;
        EtcStatusPropertyGrid.setSource({
            f_etcid: record.f_etcid,
            f_name: record.f_name,
            f_phone: record.f_phone,
            f_source: s + sourceName,
            status: record.status,
            f_desc: record.f_desc,
            f_price: record.f_price,
            appletime: record.appletime,
            f_dealtime: (record.f_dealtime === undefined) ? undefined : new Date(record.f_dealtime * 1000).toLocaleString(),
        }, {
            f_etcid: {
                displayName: 'ETC申请编码',
            },
            f_name: {
                displayName: '姓名',
            },
            f_phone: {
                displayName: '手机号码',
            },
            f_source: {
                displayName: '来源',
            },
            status: {
                displayName: '状态',
            },
            f_desc: {
                displayName: '备注',
            },
            f_price: {
                displayName: '金额',
            },
            appletime: {
                displayName: '提交时间',
            },
            f_dealtime: {
                displayName: '处理时间',
            },

        });
    },

    onRefreshBtnClick: function (button, e, eOpts) {
        var etcStatusStore = Ext.getStore('EtcStatusStore');
        var ajaxProxy = etcStatusStore.getProxy();
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        ajaxProxy.setUrl(url + "/action/etc/list.do?system=ytadmin@7788");
        etcStatusStore.load();
    },

    onExportBtnClick: function (button, e, eOpts) {

        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        var page = Ext.getStore('EtcStatusStore').currentPage;
        var pageSize = Ext.getStore('EtcStatusStore').getPageSize();
        var start = (page - 1) * pageSize;
        window.location = url + '/action/etc/export.do?system=ytadmin@7788&source=&start=' + start + '&count=' + pageSize;

    },

    onSaveBtnClick: function (button, e, eOpts) {
        var etcPanel = button.up('#etcStatusPanel');
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        var etcStatusStore = Ext.getStore('EtcStatusStore');
        var records = etcStatusStore.getModifiedRecords().slice(0);
        if (records.length < 1) {
            return;
        }
        Ext.MessageBox.confirm('请确认', '您确认修改吗？', function (btn) {
            if (btn === 'no') {
                return;
            } else if (btn === 'yes') {


                var jsonArray = [];
                Ext.each(records, function (item) {
                    var f_etcid = item.data.f_etcid;
                    var f_status = item.data.f_status;
                    var f_price = item.data.f_price;
                    var f_desc = item.data.f_desc;
                    jsonArray.push({
                        f_etcid: f_etcid,
                        f_status: f_status,
                        f_price: f_price,
                        f_desc: f_desc,

                    });
                });
                Ext.Ajax.request({

                    url: url + "/action/etc/update.do",
                    params: {
                        status: JSON.stringify(jsonArray),
                    },

                    success: function (response) {
                        var text = response.responseText;
                        var result = JSON.parse(text);

                        if (result === null) {
                            Ext.Msg.alert('提示', '保存出错了，结果：' + result);
                            return;
                        }

                        if (result[0].succeed) {

                            alert('保存成功');
                            var etcStatusStore = Ext.getStore('EtcStatusStore');
                            var ajaxProxy = etcStatusStore.getProxy();
                            var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
                            ajaxProxy.setUrl(url + "/action/etc/list.do?system=ytadmin@7788");
                            etcStatusStore.load();

                        } else {
                            Ext.Msg.alert('提示', '保存出错了，错误：' + result.ptError);
                            return;
                        }
                    },

                    failure: function () {
                        Ext.Msg.alert('提示', '失败');
                    },
                });

            }

        });


    },

    onEtcStatusPanelRender: function (component, eOpts) {
        this.onRefreshBtnClick(null, null, null);
    }

});
