/*
 * File: app/view/HgCarEnquiryRequestPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CallCenterApp.view.HgCarEnquiryRequestPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.hgcarenquiryrequestpanel',

    onCarBrandSelect: function(combo, records, eOpts) {
        var brandId=records[0].data.id;

        var carsetStore=Ext.getStore('CarsetStore');

        var ajaxProxy=carsetStore.getProxy();

        var url=Ext.getStore('ConfigStore').getAt(0).get('CarBrandServerUrl');
        ajaxProxy.setUrl(url + "/car/queryCarset?id="+brandId);
        carsetStore.load();


        /**2,更新询价登记记录***/
        var CarReportPriceStore=Ext.getStore('CarReportPriceStore');
        var ajaxProxy=CarReportPriceStore.getProxy();

        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderServerUrl');
        ajaxProxy.setUrl(url + "/hg/carenquiry/list.do?brandId="+brandId);
        CarReportPriceStore.load();
    },

    onCarsetSelect: function(combo, records, eOpts) {
        var carsetId=records[0].data.id;
        if(carsetId===0){
            return;
        }

        var carTypeStore=Ext.getStore('CarTypeStore');

        var ajaxProxy=carTypeStore.getProxy();

        var url=Ext.getStore('ConfigStore').getAt(0).get('CarBrandServerUrl');
        ajaxProxy.setUrl(url + "/car/queryCar?id="+carsetId);
        carTypeStore.load();
    },

    onCarTypeSelect: function(combo, records, eOpts) {
        var carTypeId=records[0].data.id;
        if(carTypeId===null){
            return;
        }

        /**1,根据carTypeId获取颜色信息**/
        var CarColorStore=Ext.getStore('CarColorStore');
        var ajaxProxy=CarColorStore.getProxy();

        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderServerUrl');
        ajaxProxy.setUrl(url + "/hg/carenquiry/color/get.do?cartypeid="+carTypeId);
        CarColorStore.load();


        /**2,更新询价登记记录***/
        var CarReportPriceStore=Ext.getStore('CarReportPriceStore');
        var ajaxProxy=CarReportPriceStore.getProxy();

        var url = Ext.getStore('ConfigStore').getAt(0).get('OrderServerUrl');
        ajaxProxy.setUrl(url + "/hg/carenquiry/list.do?cartypeid="+carTypeId);
        CarReportPriceStore.load();



    },

    onContactInformationFieldBlur: function(component, event, eOpts) {
        if(!component.validate()){
            Ext.Msg.alert('错误提示','请输入正确手机号码!');
        }
    },

    onSaveBtnClick: function(button, e, eOpts) {
        Ext.MessageBox.confirm('请确认', '确认提交？请确认报价信息和车辆信息是否正确！', function(btn){

            if(btn==='no'){
                return;
            }else if(btn==='yes'){

                var HgCarEnquiryRequestPanel=button.up('#HgCarEnquiryRequestPanel');

                /***车辆详情和获取值****/
                var carBrandField=HgCarEnquiryRequestPanel.down('#carBrand');

                var carsetField=HgCarEnquiryRequestPanel.down('#carset');

                var carTypeField=HgCarEnquiryRequestPanel.down('#carType');

                var carColorField=HgCarEnquiryRequestPanel.down('#carColor');

                if(carBrandField.getValue()===null||carsetField.getValue()===null||carTypeField.getValue()===null||carColorField.getValue()===null){
                    Ext.Msg.alert('错误提示','请选择必要的车辆信息!');
                    return;
                }
                if(carBrandField.getValue()===''||carsetField.getValue()===''||carTypeField.getValue()===''||carColorField.getValue()===''){
                    Ext.Msg.alert('错误提示','请选择必要的车辆信息!');
                    return;
                }

                var carBrandId=carBrandField.selection.data.id;
                var carBrand = carBrandField.selection.data.name;

                var carsetId=carsetField.selection.data.id;
                var carset = carsetField.selection.data.name;

                var carTypeId=carTypeField.selection.data.id;
                var carType = carTypeField.selection.data.name;

                var color=carColorField.rawValue;



                /*****询价详情和获取值****/
                var reportPriceField=HgCarEnquiryRequestPanel.down('#reportPriceField');

                var limitDateField=HgCarEnquiryRequestPanel.down('#limitDateField');

                var dealerNameField=HgCarEnquiryRequestPanel.down('#dealerNameField');

                var linkmanNameField = HgCarEnquiryRequestPanel.down('#linkmanNameField');

                var contactInformationField=HgCarEnquiryRequestPanel.down('#contactInformationField');


                var price=reportPriceField.getValue()*10000;/**报价金额页面输入单位为万元，存储为元**/
                var date=limitDateField.getValue();
                date= date===null?null:new Date(date).getTime()/1000;
                var dealerName=dealerNameField.getValue();
                var linkmanName=linkmanNameField.getValue();
                var contactInformation= contactInformationField.getValue();

                if(price===0||date===null||linkmanName===null||contactInformation===null){
                    Ext.Msg.alert('错误提示','请选择必要的询价信息!');
                    return;
                }
                if(price===0||date===''||linkmanName===''||contactInformation===''){
                    Ext.Msg.alert('错误提示','请选择必要的询价信息!');
                    return;
                }

                /**获取LoginSuccessJsonStore中的data**/
                var LoginSuccessStore = Ext.getStore('LoginSuccessJsonStore');
                var userId=LoginSuccessStore.data.items[0].data.userId;

                var data={
                    f_carbrand:carBrand,
                    f_carset:carset,
                    f_cartype:carType,
                    f_carbrandid:carBrandId,
                    f_carsetid:carsetId,
                    f_cartypeid:carTypeId,
                    f_price:price,
                    f_validtime:date,
                    f_ncname:dealerName,
                    f_mid:userId,
                    f_saleman:linkmanName,
                    f_salephone:contactInformation,
                    f_color:color
                };

                var url = Ext.getStore('ConfigStore').getAt(0).get('OrderServerUrl');
                Ext.Ajax.request({
                    headers:{'Content-Type':'application/json'},
                    url: url + '/hg/carenquiry/add.do',
                    params: JSON.stringify(data),
                    success: function (response) {
                        var text = response.responseText;
                        var result = JSON.parse(text);

                        if (result === null) {
                            Ext.Msg.alert('提示', '保存出错了，结果：' + text);
                            return;
                        }

                        if (result.succeed === true) {
                            Ext.Msg.alert('提示', '保存成功');



                            reportPriceField.reset();

                            limitDateField.reset();

                            dealerNameField.reset();

                            linkmanNameField.reset();

                            contactInformationField.reset();
                            /***车辆信息无需清空，登记历史查询时需要使用字段信息***/

                            var CarReportPriceStore=Ext.getStore('CarReportPriceStore');
                            var ajaxProxy=CarReportPriceStore.getProxy();

                            var url = Ext.getStore('ConfigStore').getAt(0).get('OrderServerUrl');
                            ajaxProxy.setUrl(url + "/hg/carenquiry/list.do?cartypeid="+carTypeId);
                            CarReportPriceStore.load();



                        } else {
                            Ext.Msg.alert('提示', '保存出错了，错误：' + result.errMsg);
                        }
                    }
                });



            }
        });


    },

    onHgCarEnquiryRequestPanelRender: function(component, eOpts) {
        var carBrandStore = Ext.getStore('CarBrandStord');

        if(carBrandStore.data.length>0){/**carBrandStore中已有数据***/
            return;
        }

        var ajaxProxy = carBrandStore.getProxy();
        var url = Ext.getStore('ConfigStore').getAt(0).get('CarBrandServerUrl');
        ajaxProxy.setUrl(url + "/car/queryBrand");
        carBrandStore.load();
    }

});
