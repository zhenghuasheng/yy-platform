/*
 * File: app/view/RestPasswordPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CallCenterApp.view.RestPasswordPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.restpasswordpanel',

    onverifyButtonClick: function (button, e, eOpts) {
        /**获取表单选项值的方式一：**/
        //     var view = this.getView();
        //     var resetform = button.up('#resetpwdform');
        //     var phoneField = resetform.down('#phone');
        //     var phone=phoneField.getValue();
        /***********************************************/
        /**h获取表单选项值的方式二：*/
        var formObj = Ext.getCmp('resetpwdform');
        var base = formObj.getForm();
        var phoneField = base.findField('phone');
        var phone = phoneField.getValue();
        /**_______________________________________________*/

        // Success
        var successCallback = function (resp, ops) {

            var result = JSON.parse(resp.responseText);
            if (result.flag === "0") {
                Ext.Msg.alert("验证码提示", "验证码获取" + result.msg + ",打死不要泄露!");
            }
        };

        // Failure
        var failureCallback = function (resp, ops) {

            Ext.Msg.alert('Registration Failure', resp);

        };
        var url = Ext.getStore('ConfigStore').getAt(1).get('UserServerUrl');
        Ext.Ajax.request({
            method: 'POST',
            url: url + "/user/verify.do",
            params: {
                phone: phone,
            },
            success: successCallback,
            failure: failureCallback
        });

        // Just run success for now
        //successCallback();

    },

    onsubmitButtonClick: function (button, e, eOpts) {
        var view = this.getView();
        var form = button.up('#resetpwdform');
        var phoneField = form.down('#phone');
        var verifyFild = form.down('#verify');
        var passwordField = form.down('#newpwd');

        var successCallback = function (resp, ops) {

            var result = JSON.parse(resp.responseText);
            if (result.flag === "0") {
                Ext.Msg.alert("提示", "密码重置成功！");
                form.reset();
            } else {
                Ext.Msg.alert('Reset Failure', result.msg);

            }

        };

        // Failure
        var failureCallback = function (resp, ops) {
            var result = JSON.parse(resp.responseText);
            Ext.Msg.alert('Registration Failure', result.msg);

        };

        // TODO: Register using server-side authentication service
        var url = Ext.getStore('ConfigStore').getAt(1).get('UserServerUrl');
        Ext.Ajax.request({
            method: "POST",
            url: url + "/user/pwd/reset.do",
            params: {
                phone: phoneField.getValue(),
                verify: verifyFild.getValue(),
                pwd: Ext.MD5(passwordField.getValue() + verifyFild.getValue()),

            },
            success: successCallback,
            failure: failureCallback
        });

    }

});
