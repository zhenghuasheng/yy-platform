/*
 * File: app/view/HgStatusPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CallCenterApp.view.HgStatusPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.hgstatuspanel',

    onStatusGridPanelRowDblClick: function (tableview, record, tr, rowIndex, e, eOpts) {
        this.onDetailBtnClick(null, e, eOpts);
    },

    onStatusGridPanelCellContextMenu: function (tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        var targetDel = '/action/hg/delete.do';
        var storeId = 'HgStatusStore';
        var refreshUrl = "/action/hg/list.do?system=ytadmin@7788";
        var rightMenu = new CallCenterApp.view.RightClickMenu({
            record: record,
            targetDel: targetDel,
            storeId: storeId,
            refreshUrl: refreshUrl
        });
        e.preventDefault();
        //定位。显示 右键菜单
        rightMenu.showAt(e.getXY());

    },

    onHgStatusGridPanelRowClick: function (tableview, record, tr, rowIndex, e, eOpts) {
        var HgStatusPropertyPanel = Ext.getCmp('HgStatusPropertyPanel');
        var record = record.data;
        /**性别判定**/
        var sex;
        if (record.f_sex === 0) {
            sex = '男';
        } else if (record.f_sex === 1) {
            sex = '女';
        } else {
            sex = '未知';
        }

        /**婚姻状况判定*/
        var marriage;
        if (record.f_marriage === 0) {
            marriage = '未婚';
        } else if (record.f_marriage === 1) {
            marriage = '已婚';
        } else {
            marriage = '未知';
        }
        /**家庭住址**/

        var addressArray = (record.f_address === undefined) ? null : record.f_address.split(';');
        var address = (addressArray[5] === 'null') ? undefined : addressArray[5];

        HgStatusPropertyPanel.setSource({
            f_name: record.f_name,
            f_phone: record.f_phone,
            f_idcard: record.f_idcard,
            f_sex: sex,
            f_marriage: marriage,
            f_address: address,
            f_mid: record.f_mid,
            f_company: record.f_company,
            f_matecompany: record.f_matecompany,
            f_mateidcard: record.f_mateidcard,
            f_matename: record.f_matename,
            f_matephone: record.f_matephone,
            f_status: record.status,
            appletime: record.appletime,
            f_source: record.f_source,
            f_price: (record.f_price === undefined) ? undefined : record.f_price + '万',
            f_desc: record.f_desc,

        }, {
            f_name: {
                displayName: '姓名',
            },
            f_phone: {
                displayName: '电话',
            },
            f_idcard: {
                displayName: '身份证',
            },
            f_sex: {
                displayName: '性别',
            },
            f_marriage: {
                displayName: '婚姻状况',
            },
            f_address: {
                displayName: '家庭住址',
            },
            f_mid: {
                displayName: '客户ID',
            },
            f_company: {
                displayName: '公司',
            },
            f_matecompany: {
                displayName: '配偶公司',
            },
            f_mateidcard: {
                displayName: '配偶身份证',
            },
            f_matename: {
                displayName: '配偶姓名',
            },
            f_matephone: {
                displayName: '配偶手机',
            },
            f_status: {
                displayName: '状态',
            },
            appletime: {
                displayName: '提交时间',
            },
            f_source: {
                displayName: '来源',
            },
            f_price: {
                displayName: '融资金额',
            },
            f_desc: {
                displayName: '备注',
            }


        });


    },

    onRefreshBtnClick: function (button, e, eOpts) {
        var hgStatusStore = Ext.getStore('HgStatusStore');
        var ajaxProxy = hgStatusStore.getProxy();
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        ajaxProxy.setUrl(url + "/action/hg/list.do?system=ytadmin@7788");
        hgStatusStore.load();

    },

    onExportBtnClick: function (button, e, eOpts) {
        var page = Ext.getStore('HgStatusStore').currentPage;
        var pageSize = Ext.getStore('HgStatusStore').getPageSize();
        var start = (page - 1) * pageSize;
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        window.location = url + '/action/hg/export.do?system=ytadmin@7788&source=&start=' + start + '&count=' + pageSize;
    },

    onDetailBtnClick: function (button, e, eOpts) {
        var hgStatusPanel = Ext.getCmp('hgStatusPanel');
        var statusGrid = hgStatusPanel.down('#StatusGridPanel');

        if (statusGrid.selection === null) {
            return;
        }

        var hgRequestPanel = new CallCenterApp.view.HgRequestPanel({
            f_ciid: statusGrid.selection.data.f_ciid,
            closable: false,
            autoScroll: false,
            title: ''
        });

        var nameField = hgRequestPanel.down('#nameField');
        var phoneField = hgRequestPanel.down('#phoneField');
        var idCardField = hgRequestPanel.down('#idCardField');
        var marryField = hgRequestPanel.down('#marryField');
        var wifeNameField = hgRequestPanel.down('#wifeNameField');
        var wifePhoneField = hgRequestPanel.down('#wifePhoneField');
        var wifeIdCardField = hgRequestPanel.down('#wifeIdCardField');
        var sexField = hgRequestPanel.down('#sexField');
        var provinceField = hgRequestPanel.down('#provinceField');
        var cityField = hgRequestPanel.down('#cityField');
        var districtField = hgRequestPanel.down('#districtField');
        var streetField = hgRequestPanel.down('#streetField');
        var addressField = hgRequestPanel.down('#addressField');
        var houseField = hgRequestPanel.down('#houseRadioGroup');
        var mpayField = hgRequestPanel.down('#mpayField');
        var buyDateField = hgRequestPanel.down('#buyDateField');
        var rentDateField = hgRequestPanel.down('#rentDateField');
        var areaField = hgRequestPanel.down('#areaField');
        var houseAddrField = hgRequestPanel.down('#houseAddrField');
        var companyField = hgRequestPanel.down('#company');
        var jobField = hgRequestPanel.down('#jobTitle');
        var jobAgeField = hgRequestPanel.down('#jobAge');
        var incomeField = hgRequestPanel.down('#incomeField');
        var otherIncomeField = hgRequestPanel.down('#otherIncomeField');
        var bankSeriaField = hgRequestPanel.down('#bankSeriaField');
        var outDateField = hgRequestPanel.down('#outDateRadioGroup');
        var outNumField = hgRequestPanel.down('#outNumField');
        var buyCarInChangsha = hgRequestPanel.down('#buyCarInChangsha');
        var useCarCityField = hgRequestPanel.down('#useCarCityField');
        var loveCarField = hgRequestPanel.down('#loveCarField');
        var lookedCarField = hgRequestPanel.down('#lookedCarField');
        var carPriceField = hgRequestPanel.down('#carPriceField');
        var depositField = hgRequestPanel.down('#depositField');
        var loanMoneyField = hgRequestPanel.down('#loanMoneyField');

        var wifeCompanyField = hgRequestPanel.down('#wifeCompany');
        var wifeJobField = hgRequestPanel.down('#wifeJobTitle');
        var wifeJobAgeField = hgRequestPanel.down('#wifeJobAge');
        var wifeIncomeField = hgRequestPanel.down('#wifeIncomeField');
        var wifeBankSeriaField = hgRequestPanel.down('#wifeBankSeriaField');
        var wifeOtherIncomeField = hgRequestPanel.down('#wifeOtherIncomeField');

        var myForm = new Ext.window.Window({
            modal: true,
            autoScroll: true,
            title: '融资申请',
            width: 560,
            height: 600,
            resizable: true
        });

        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        Ext.Ajax.request({
            url: url + '/action/hg/detail.do',
            params: {
                f_ciid: statusGrid.selection.data.f_ciid
            },

            success: function (response) {
                var result = JSON.parse(response.responseText);
                nameField.setValue(result.object.hgRequest.f_name);
                phoneField.setValue(result.object.hgRequest.f_phone);
                idCardField.setValue(result.object.hgRequest.f_idcard);
                sexField.setValue({sex: result.object.hgRequest.f_sex});
                marryField.setValue({marry: result.object.hgRequest.f_marriage});
                var addressArray = result.object.hgRequest.f_address.split(';');
                addressField.setValue(addressArray[5] === 'null' ? '' : addressArray[5]);
                var houseArray = result.object.hgRequest.f_house.split(';');
                houseField.setValue({house: houseArray[0]});

                if (houseArray[1] > 0) {
                    buyDateField.setValue(new Date(houseArray[1] * 1000));
                }

                mpayField.setValue(houseArray[2] > 0 ? houseArray[2] : '');
                areaField.setValue(houseArray[3] > 0 ? houseArray[3] : '');
                houseAddrField.setValue(houseArray[5] === 'null' ? '' : houseArray[5]);

                if (houseArray[4] > 0) {
                    rentDateField.setValue(new Date(houseArray[4] * 1000));
                }

                companyField.setValue(result.object.hgRequest.f_company);
                var jobArray = result.object.hgRequest.f_position.split(';');
                jobField.setValue(jobArray[0] === 'null' ? '' : jobArray[0]);
                jobAgeField.setValue(jobArray[1] < 0 ? '' : jobArray[1]);
                var incomeArray = result.object.hgRequest.f_income.split(';');
                incomeField.setValue({income: incomeArray[0]});
                otherIncomeField.setValue(incomeArray[1]);
                bankSeriaField.setValue({bank: incomeArray[2]});
                var creditArray = result.object.hgRequest.f_credit.split(';');
                outDateField.setValue({outdate: creditArray[0]});
                outNumField.setValue(creditArray[1] < 0 ? '' : creditArray[1]);
                var buyCarArray = result.object.hgRequest.f_buycar.split(';');
                buyCarInChangsha.setValue({city: buyCarArray[0]});
                useCarCityField.setValue(buyCarArray[1] === 'null' ? '' : buyCarArray[1]);
                loveCarField.setValue(buyCarArray[2] === 'null' ? '' : buyCarArray[2]);
                var financingArray = result.object.hgRequest.f_financing.split(';');
                lookedCarField.setValue({look: financingArray[0]});
                carPriceField.setValue(financingArray[1] > 0 ? financingArray[1] : '');
                depositField.setValue({deposit: financingArray[2]});
                loanMoneyField.setValue(financingArray[3] > 0 ? financingArray[3] : '');

                if (result.object.hgRequest.f_marriage === 1) {
                    wifeNameField.setValue(result.object.hgRequest.f_matename);
                    wifePhoneField.setValue(result.object.hgRequest.f_matephone);
                    wifeIdCardField.setValue(result.object.hgRequest.f_mateidcard);
                    wifeCompanyField.setValue(result.object.hgRequest.f_company);

                    var wifeJobArray = result.object.hgRequest.f_mateposition.split(';');
                    wifeJobField.setValue(wifeJobArray[0] === 'null' ? '' : wifeJobArray[0]);
                    wifeJobAgeField.setValue(wifeJobArray[1] < 0 ? '' : wifeJobArray[1]);
                    var wifeIncomeArray = result.object.hgRequest.f_mateincome.split(';');
                    wifeIncomeField.setValue({wifeincome: wifeIncomeArray[0]});
                    wifeOtherIncomeField.setValue(wifeIncomeArray[1]);
                    wifeBankSeriaField.setValue({wifebank: wifeIncomeArray[2]});
                }
            }
        });

        myForm.add(hgRequestPanel);
        myForm.show();

    },

    onSubmitBtnClick: function (button, e, eOpts) {
        var hgStatusPanel = Ext.getCmp('hgStatusPanel');
        var statusGrid = hgStatusPanel.down('#StatusGridPanel');

        if (statusGrid.selection === null) {
            return;
        }

        var deptStore = Ext.getStore('DeptStore');
        var ajaxProxy = deptStore.getProxy();
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        ajaxProxy.setUrl(url + "/action/hg/department.do");
        deptStore.load();
        var hgSubmitWindow = new CallCenterApp.view.SubmitWindow({
            requestId: statusGrid.selection.data.f_ciid
        });

        hgSubmitWindow.show();
    },

    onSaveBtnClick: function (button, e, eOpts) {
        var hgStatusPanel = button.up('#hgStatusPanel');
        var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
        var hgStatusStore = Ext.getStore('HgStatusStore');
        var records = hgStatusStore.getModifiedRecords().slice(0);
        if (records.length < 1) {
            return;
        }
        Ext.MessageBox.confirm('请确认', '您确认修改吗？', function (btn) {
            if (btn === 'no') {
                return;
            } else if (btn === 'yes') {


                var jsonArray = [];
                Ext.each(records, function (item) {
                    var f_ciid = item.data.f_ciid;
                    var f_status = item.data.f_status;
                    var f_price = item.data.f_price;
                    var f_desc = item.data.f_desc;
                    jsonArray.push({f_ciid: f_ciid, f_status: f_status, f_price: f_price, f_desc: f_desc});
                });
                Ext.Ajax.request({

                    url: url + "/action/hg/update.do",
                    params: {
                        hgStr: JSON.stringify(jsonArray),
                    },

                    success: function (response) {
                        var text = response.responseText;
                        var result = JSON.parse(text);

                        if (result === null) {
                            Ext.Msg.alert('提示', '保存出错了，结果：' + result);
                            return;
                        }

                        if (result[0].succeed) {

                            alert('保存成功');
                            var hgStatusStore = Ext.getStore('HgStatusStore');
                            var ajaxProxy = hgStatusStore.getProxy();
                            var url = Ext.getStore('ConfigStore').getAt(0).get('WebServerUrl');
                            ajaxProxy.setUrl(url + "/action/hg/list.do?system=ytadmin@7788");
                            hgStatusStore.load();

                        } else {
                            Ext.Msg.alert('提示', '保存出错了，错误：' + result.ptError);
                            return;
                        }
                    },

                    failure: function () {
                        Ext.Msg.alert('提示', '失败');
                    },
                });

            }

        });

    },

    onHgStatusPanelRender: function (component, eOpts) {
        this.onRefreshBtnClick(null, null, null);
    }

});
