/*
 * File: app/controller/Account.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('platformApp.controller.Account', {
    extend: 'Ext.app.Controller',

    config: {
        refs: {
            mainView: 'mainview',
            loginPanel: 'mainview #loginPanel',
            welcomePanel: 'mainview #welcomePanel'
        },

        control: {
            "mainview #showLoginButton": {
                tap: 'showLogin'
            },
            "mainview #showRegisterButton": {
                tap: 'showRegister'
            },
            "loginform #loginButton": {
                tap: 'login'
            },
            "registerform #registerButton": {
                tap: 'register'
            }
        }
    },

    showLogin: function(button, e, eOpts) {
        var loginForm = Ext.create('widget.loginform'),	// Login form
            mainView = this.getMainView();				// Main view

        // Navigate to login
        mainView.push({
            xtype: "loginform",
            title: "登录"
        });

    },

    showRegister: function(button, e, eOpts) {

        var registerForm = Ext.create('widget.registerform'),	// Registration form
            mainView = this.getMainView();						// Main view

        // Navigate to register
        mainView.push({
            xtype: "registerform",
            title: "注册"
        });

    },

    login: function(button, e, eOpts) {
        var preLoginStore = Ext.getStore('PreLoginStore').getAt(0);
        if(preLoginStore === undefined || preLoginStore === null){
            Ext.Msg.alert("登录失败", '手机号码不能为空');
            return;
        }

        var form = button.up('formpanel'),			// Login form
        	values = form.getValues(),				// Form value
        	mainView = this.getMainView(),			// Main view
        	loginPanel = this.getLoginPanel(),		// Login and register buttons
        	welcomePanel = this.getWelcomePanel();	// Welcome panel

        // Success
        var successCallback = function(resp, ops) {

            var result =JSON.parse(resp.responseText);

            if(result.succeed) {
                 // Go back
                mainView.pop();

                // Hide login panel
                loginPanel.hide();

                // Show welcome panel
               // welcomePanel.show();

                var  workpanel = Ext.create('widget.mapPanel');
                  mainView.push({
                    xtype: "mapPanel",
                    title: "地图"
                });


            }else {
                Ext.Msg.alert("登录失败", result.description);
                return;
            }



        };

        // Failure
        var failureCallback = function(resp, ops) {

            // Show login failure error
            Ext.Msg.alert("登录失败", "用户名或密码错误");

        };


         var params = Ext.Object.merge({},values,{"system":"1000"});
        //TODO: Login using server-side authentication service
        Ext.Ajax.request({
        	url: "/user/login.do",
        	params:  params,
            headers: {
                token:preLoginStore.get('token'),
            },
        	success: successCallback,
        	failure: failureCallback
        });

    },

    register: function(button, e, eOpts) {

        var form = button.up('formpanel'),			// Login form
            values = form.getValues(),				// Form values
            mainView = this.getMainView(),			// Main view
            loginPanel = this.getLoginPanel(),		// Login and register buttons
            welcomePanel = this.getWelcomePanel();	// Welcome panel

        // Success
        var successCallback = function(resp, ops) {
            var result = JSON.parse(resp.responseText);
            if(result.succeed){
                  // Go back
                mainView.pop();

        //         Hide login panel
                loginPanel.hide();

                showLogin(null,null,null);
                // Show welcome panel
        //         welcomePanel.show();

            }else {
                 Ext.Msg.alert("注册失败", "信息添加不完整请重试");
            }


        };

        // Failure
        var failureCallback = function(resp, ops) {

            // Show login failure error
            Ext.Msg.alert("注册失败", "请与管理员联系");

        };


        // TODO: Register using server-side authentication service
        var params = Ext.Object.merge({},values,{"system":"1000"});

        Ext.Ajax.request({
        		url: "/user/register.do",
        		params: params,
        		success: successCallback,
        		failure: failureCallback
        });

        // Just run success for now
        successCallback();
    }

});